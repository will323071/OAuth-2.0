const { default: axios } = require("axios")

const kakaoLoginButton = document.querySelector('#kakao')
const naverLoginButton = document.querySelector('#naver')
const userImage = document.querySelector('img')
const userName = document.querySelector('#user_name')
const LogoutButton = document.querySelector('#logout_button')

let currentOAuthServie = "";
let kakaoAccessToken = "";
let naverAccessToken = "";

function renderUserInfi(imgURL, name) {
  userImage.src = imgURL;
  userName.textContent = name;
}

kakaoLoginButton.onclick = () => {
  location.href = "https://localhost:3000/auth/kakao";
};

window.onload = () => {
const uri = new URL(location.href)
const naverState = url.searchParams.get("code");
const authorizationCode = url.searchParams.get("code");

if (!authorizationCode) return;

if (naverState) {
  axios.post("http://localhost:3000/naver/login", {authorizationCode, state: naverState,})
  .then((res) => {
    naverAccessToken = res.data;
    return axios.post("http://localhost:3000/naver/userinfo", {naverAccessToken,});
  })
  .then((res) => {
    renderUserInfo(res.data.profile_image, res.data.name);
    currentOAuthServie = "naver";
  });
} else {
  axios. post("http://localhost:3000/kakao/login", { authorizationCode })
      .then((res) => {
        kakaoAccessToken = res.data;
        return axios.post("http://localhost:3000/kakao/userinfo", { kakaoAccessToken,});
      })
      .then((res) => {
        renderUserInfo(res.data.profile_image, res.data.nickname);
        currentOAuthService = "kakao";
      });
  }
};

logoutButton.onclick = () => {
  if (currentOAuthService === "kakao") {
    axios.delete("http://localhost:3000/kakao/logout", { data: { kakaoAccessToken },})
      .then((res) => {
        {
          console.log(res.data);
          renderUserInfo("", "");
        }
      });
  } else if (currentOAuthService === "naver") {
    axios.delete("http://localhost:3000/naver/logout", { data: { naverAccessToken },})
      .then((res) => {
        {
          console.log(res.data);
          renderUserInfo("", "");
        }
      });
  }
};
